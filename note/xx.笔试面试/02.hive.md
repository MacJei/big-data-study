## hive的理解和优化策略

- hive的概念

  - 数据仓库工具
  - 数据存储在hdfs
  - 元数据存储在metastore里面
  - 把结构化的文件映射到一张表中

- hive的本质

  - 将HQL语句转换为MR程序
  - MR程序的解析器
  - 基于Hadoop
    - 把HQL转换为MR
    - 调用HDFS上数据
    - 调用Yarn

- 优化策略

  - 表的优化
    - 大表join大表
      - 空key的过滤
      - 空key的转换，随机
  - MapJoin
    - 大表join小表 
      - 小表存储在内存中
    - 只有Map
    - 没有reduce阶段
    - 少了IO
    - 没有数据倾斜
  - GroupBy的优化
    - 设置数据参数，解决数据倾斜
    - 生成2个MR
  - 列过滤
    - 尽量不用select * 
    - 尽量用分区过滤，分目录，指定分区字段
      - 提高查询效率
  - 行过滤
    - 先过滤，再join
  - JVM重用
    - 重点
  - 本地模式
  - 并行执行
  - 压缩

  

## Hive中，建的表为压缩表，输入文件为非压缩格式，会有什么现象和结果

- 如果表为压缩表
  - 要求表中的数据为压缩格式
  - 导入的数据为非压缩格式
- load data方式导入数据
  - 查询表中的数据，无法解析
  - 查询不到表中的数据
- insert  select 方式导入
  - 执行MR程序
  - 将数据压缩后导入表中
  - 可以查询到数据



## mapjoin原理和实际应用

![1](../02.hive/img/hive/35.png)



## 开窗函数

![1](../02.hive/img/hive/36.png)

- 需求

  - 分组TOPN ，选出2016年每个学校，每个年级，分数前三的科目
    - 每个学校，每个年级，每个科目的前三
  - 考虑到开窗函数
    - rank
    - dense_rank
    - row_number

  ```sql
  select time,shool,grade,name,subject,score,rank
  from(
      select time,school,grade,name,subject,score,
      row_number() over(
          partition by school, grade ,subject
          order by score desc ) rank
      from tb_score
      where time = 2016
  ) t
  where t.rank <=3;
  ```

  